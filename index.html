<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MPA-50: Manufacturing Personality Assessment</title>
  <style>
    /* Enhanced Professional Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      /* Softer, modern gradient background for improved legibility */
      background: linear-gradient(135deg, #f0f4ff 0%, #e2e8f0 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .card {
      background: #ffffff;
      border-radius: 20px;
      /* Lighter shadow for a softer look */
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
      padding: 40px;
      margin-bottom: 30px;
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h1 {
      color: #2d3748;
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-align: center;
    }
    
    h2 {
      color: #4a5568;
      font-size: 1.8rem;
      margin-bottom: 20px;
      border-bottom: 3px solid #5a67d8;
      padding-bottom: 10px;
    }
    
    h3 {
      color: #4a5568;
      font-size: 1.3rem;
      margin: 20px 0 10px 0;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    
    .btn {
      display: inline-block;
      padding: 14px 32px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      /* Refreshed primary gradient for a modern feel */
      background: linear-gradient(135deg, #5a67d8 0%, #805ad5 100%);
      color: #ffffff;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }
    
    .btn-danger {
      background: #f56565;
      color: white;
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    /* Mini heat map styling for summary tables */
    .mini-heat {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 6px 0;
    }
    .mini-cell {
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      font-size: 0.8rem;
      border-radius: 4px;
      color: white;
    }
    .mini-cell.good {
      background: #48bb78;
    }
    .mini-cell.moderate {
      background: #ecc94b;
      color: #4a5568;
    }
    .mini-cell.concerning {
      background: #f56565;
    }
    .mini-cell.empty {
      background: #e2e8f0;
      color: #4a5568;
    }
    .mini-cell.reverse {
      border: 2px solid #805ad5;
    }

    /* Trait summary cards */
    .trait-summary {
      background: #f7fafc;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .trait-summary h4 {
      margin-bottom: 6px;
      color: #2d3748;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .trait-summary p {
      margin: 4px 0;
      color: #4a5568;
      line-height: 1.4;
      font-size: 0.95rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Progress Bar */
    .progress-container {
      margin-bottom: 30px;
    }
    
    .progress-wrapper {
      background: #e2e8f0;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .progress-label {
      text-align: center;
      margin-top: 10px;
      color: #4a5568;
      font-weight: 600;
    }
    
    /* Likert Scale */
    .question-item {
      background: #f7fafc;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20ពា;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .question-item:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }
    
    .question-number {
      display: inline-block;
      background: #667eea;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      font-weight: bold;
      margin-right: 10px;
    }
    
    .question-text {
      font-size: 1.1rem;
      color: #2d3748;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .likert-scale {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .likert-option {
      flex: 1;
      text-align: center;
    }
    
    .likert-option input[type="radio"] {
      display: none;
    }
    
    .likert-option label {
      display: block;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .likert-option input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
      transform: scale(1.05);
    }
    
    .likert-option label:hover {
      background: #f7fafc;
      border-color: #667eea;
    }
    
    .likert-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.85rem;
      color: #718096;
      padding: 0 15px;
    }
    
    /* Input Fields */
    input[type="text"], input[type="email"], input[type="password"], select {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 20px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    /* Score Display */
    .score-display {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
    }
    
    .score-card {
      flex: 1;
      min-width: 200px;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }
    
    .score-label {
      font-size: 0.9rem;
      color: #718096;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .score-value {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .score-band {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 5px;
    }
    
    .band-high { background: #c6f6d5; color: #22543d; }
    .band-medium { background: #fed7aa; color: #7c2d12; }
    .band-low { background: #fed7d7; color: #742a2a; }
    .band-strong { background: #c6f6d5; color: #22543d; }
    
    /* Report Sections */
    .report-section {
      background: #f7fafc;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
      border-left: 5px solid #667eea;
    }
    
    .interpretation-box {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .risk-indicator {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      margin: 10px 0;
    }
    
    .risk-low { background: #c6f6d5; color: #22543d; }
    .risk-moderate { background: #fefcbf; color: #744210; }
    .risk-high { background: #fed7d7; color: #742a2a; }
    
    /* Heat Map Styles */
    .heatmap-container {
      margin: 20px 0;
      overflow-x: auto;
    }
    
    .heatmap-grid {
      display: grid;
      grid-template-columns: 150px repeat(50, 30px);
      gap: 2px;
      font-size: 0.8rem;
      margin: 20px 0;
    }
    
    .heatmap-cell {
      padding: 8px 4px;
      text-align: center;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }
    
    .heatmap-cell:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #2d3748;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 1000;
      font-size: 0.75rem;
    }
    
    .heatmap-row-label {
      background: #4a5568;
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .heat-1 { background: #742a2a; } /* Strongly Disagree - Dark Red */
    .heat-2 { background: #e53e3e; } /* Disagree - Red */
    .heat-3 { background: #ecc94b; } /* Neutral - Yellow */
    .heat-4 { background: #48bb78; } /* Agree - Green */
    .heat-5 { background: #22543d; } /* Strongly Agree - Dark Green */
    .heat-rev { border: 3px solid #805ad5; } /* Reverse scored indicator */
    
    /* Collapsible Sections */
    .collapsible {
      background: #4a5568;
      color: white;
      cursor: pointer;
      padding: 15px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    
    .collapsible:hover {
      background: #2d3748;
    }
    
    .collapsible:after {
      content: '\002B';
      color: white;
      float: right;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .collapsible.active:after {
      content: '\2212';
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #f7fafc;
      border-radius: 0 0 8px 8px;
    }
    
    .collapsible-content.active {
      max-height: 2000px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      border-top: none;
    }
    
    /* Interview Questions Styling */
    .interview-section {
      background: #fff;
      border-left: 4px solid #667eea;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
    }
    
    .interview-category {
      margin-bottom: 25px;
    }
    
    .interview-category h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .interview-question {
      background: #f7fafc;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 3px solid #cbd5e0;
    }
    
    .interview-question.critical {
      border-left-color: #f56565;
      background: #fff5f5;
    }
    
    .response-table {
      width: 100%;
      font-size: 0.9rem;
    }
    
    .response-table td {
      padding: 8px;
      vertical-align: top;
    }
    
    .response-value {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    /* Print Styles */
    @media print {
      body {
        background: white;
      }
      .card {
        box-shadow: none;
        page-break-inside: avoid;
      }
      .btn {
        display: none;
      }
      .collapsible {
        display: none;
      }
      .collapsible-content {
        max-height: none !important;
        display: block !important;
        padding: 20px !important;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .card {
        padding: 20px;
      }
      h1 {
        font-size: 1.8rem;
      }
      .likert-scale {
        flex-direction: column;
        gap: 10px;
      }
      .likert-option {
        width: 100%;
      }
    }
  </style>

  <!-- Include Supabase JS library for database interactions -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card" id="header-card">
      <h1>MPA-50</h1>
      <p class="subtitle">Manufacturing Personality Assessment</p>
    </div>
    
    <!-- Start Screen -->
    <div id="screen-start" class="card">
      <h2>Welcome to the Manufacturing Personality Assessment</h2>
      <p style="margin: 20px 0; line-height: 1.6;">
        This scientifically-validated assessment evaluates personality traits that predict success in heavy manufacturing environments. 
        The assessment takes approximately 8-12 minutes to complete.
      </p>
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="startAssessment()">Begin Assessment</button>
        <button class="btn btn-secondary" onclick="showAdminLogin()">Administrator Access</button>
      </div>
    </div>
    
    <!-- Candidate Info Screen -->
    <div id="screen-info" class="card hidden">
      <h2>Candidate Information</h2>
      <form id="candidate-form">
        <label style="font-weight: 600; color: #4a5568;">Full Name *</label>
        <input type="text" id="candidate-name" required placeholder="Enter your full name">
        
        <label style="font-weight: 600; color: #4a5568;">Email</label>
        <input type="email" id="candidate-email" placeholder="Enter your email (optional)">
        
        <label style="font-weight: 600; color: #4a5568;">Position Applied For</label>
        <select id="candidate-position">
          <option value="">Select position...</option>
          <option value="production-operator">Production Operator</option>
          <option value="maintenance-tech">Maintenance Technician</option>
          <option value="quality-inspector">Quality Inspector</option>
          <option value="team-lead">Team Leader/Supervisor</option>
          <option value="machine-operator">Machine Operator</option>
          <option value="warehouse">Warehouse Worker</option>
          <option value="other">Other</option>
        </select>
        
        <label style="font-weight: 600; color: #4a5568;">Years of Manufacturing Experience</label>
        <select id="candidate-experience">
          <option value="">Select experience...</option>
          <option value="0-1">Less than 1 year</option>
          <option value="1-3">1-3 years</option>
          <option value="3-5">3-5 years</option>
          <option value="5-10">5-10 years</option>
          <option value="10+">More than 10 years</option>
        </select>
        
        <div style="text-align: center; margin-top: 30px;">
          <button type="button" class="btn btn-secondary" onclick="showStart()">Back</button>
          <button type="submit" class="btn btn-primary">Continue</button>
        </div>
      </form>
    </div>
    
    <!-- Instructions Screen -->
    <div id="screen-instructions" class="card hidden">
      <h2>Assessment Instructions</h2>
      <div style="margin: 20px 0; line-height: 1.8;">
        <p><strong>Please read carefully:</strong></p>
        <ul style="margin: 20px 0; padding-left: 30px;">
          <li>This assessment contains 50 statements about work behaviors and preferences</li>
          <li>For each statement, indicate how much you agree or disagree</li>
          <li>Answer honestly based on your typical behavior, not what you think is the "right" answer</li>
          <li>There are no right or wrong answers - we're looking for the best fit</li>
          <li>Your responses will be kept confidential</li>
          <li>Take your time, but give your first, natural response</li>
        </ul>
        
        <div style="background: #f7fafc; border-radius: 8px; padding: 20px; margin: 20px 0;">
          <p style="font-weight: 600; margin-bottom: 10px;">Response Scale:</p>
          <p>1 = Strongly Disagree</p>
          <p>2 = Disagree</p>
          <p>3 = Neither Agree nor Disagree</p>
          <p>4 = Agree</p>
          <p>5 = Strongly Agree</p>
        </div>
        
        <div style="text-align: center;">
          <button class="btn btn-secondary" onclick="showCandidateInfo()">Back</button>
          <button class="btn btn-primary" onclick="beginAssessment()">Start Assessment</button>
        </div>
      </div>
    </div>
    
    <!-- Assessment Screen -->
    <div id="screen-assessment" class="card hidden">
      <div class="progress-container">
        <div class="progress-wrapper">
          <div class="progress-bar" id="progress-bar">0%</div>
        </div>
        <div class="progress-label">
          Question <span id="current-question">1</span> of 50
        </div>
      </div>
      
      <div id="questions-container"></div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-secondary" id="prev-btn" onclick="previousPage()">Previous</button>
        <button class="btn btn-primary" id="next-btn" onclick="nextPage()">Next</button>
        <button class="btn btn-success hidden" id="submit-btn" onclick="submitAssessment()">Submit Assessment</button>
      </div>
    </div>
    
    <!-- Thank You Screen -->
    <div id="screen-thankyou" class="card hidden">
      <h2 style="text-align: center; color: #48bb78;">✓ Assessment Complete</h2>
      <p style="text-align: center; margin: 20px 0; font-size: 1.2rem;">
        Thank you for completing the Manufacturing Personality Assessment.
      </p>
      <p style="text-align: center; color: #718096;">
        Your responses have been recorded. The hiring team will review your results as part of the selection process.
      </p>
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="location.reload()">Exit</button>
      </div>
    </div>
    
    <!-- Admin Login -->
    <div id="screen-admin-login" class="card hidden">
      <h2>Administrator Access</h2>
      <p style="margin-bottom: 20px;">Enter administrator password to access candidate results.</p>
      <input type="password" id="admin-password" placeholder="Enter password">
      <div style="text-align: center;">
        <button class="btn btn-secondary" onclick="showStart()">Cancel</button>
        <button class="btn btn-primary" onclick="adminLogin()">Login</button>
      </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="screen-dashboard" class="card hidden">
      <h2>Candidate Results Dashboard</h2>
      <div id="dashboard-content"></div>
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="exportResults()">Export All Results (CSV)</button>
        <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
        <button class="btn btn-primary" onclick="location.reload()">Exit</button>
      </div>
    </div>
    
    <!-- Detailed Report -->
    <div id="screen-report" class="card hidden">
      <div id="report-content"></div>
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="window.print()">Print Report</button>
        <button class="btn btn-primary" onclick="showDashboard()">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <script>
    // MPA-50 Questions (exact from the scientifically-backed assessment)
    const MPA50_QUESTIONS = [
      // Section A: Work Habits and Reliability (Conscientiousness) - Items 1-15
      "I always complete my work tasks on time.",
      "I pay close attention to details in my work.",
      "I am well-organized in how I approach my job.",
      "I follow through on commitments I make at work.",
      "I take pride in doing quality work.",
      "I prepare thoroughly before starting new tasks.",
      "I stick with difficult tasks until they are finished.",
      "I rarely make careless mistakes.",
      "I keep my work area clean and organized.",
      "I arrive at work on time every day.",
      "I work steadily without needing constant supervision.",
      "I double-check my work to make sure it's correct.",
      "I finish what I begin.",
      "I plan my work activities in advance.",
      "I take responsibility for my mistakes.",
      
      // Section B: Emotional Stability - Items 16-25
      "I remain calm when things go wrong at work.",
      "I get upset easily when work doesn't go as planned.",
      "I handle stress well.",
      "I worry a lot about work problems.",
      "I stay focused even when there are distractions.",
      "I get anxious when deadlines are tight.",
      "I keep a steady mood throughout my workday.",
      "I feel nervous when learning new job skills.",
      "I bounce back quickly from setbacks.",
      "I find it hard to relax after a difficult day at work.",
      
      // Section C: Integrity - Items 26-35
      "I would report a coworker for stealing company property.",
      "It's okay to bend the rules if nobody gets hurt.",
      "I would never lie to my supervisor about a work problem.",
      "Taking small items from work is not really stealing.",
      "I believe in being completely honest with my employer.",
      "Everyone cheats a little at work sometimes.",
      "I would admit if I accidentally damaged company equipment.",
      "It's acceptable to exaggerate your accomplishments at work.",
      "I follow company policies even when no one is watching.",
      "Most people would steal if they knew they wouldn't get caught.",
      
      // Section D: Safety Focus - Items 36-43
      "I always follow safety procedures, even when they slow me down.",
      "I look for potential safety hazards in my work area.",
      "Taking shortcuts is sometimes necessary to get the job done.",
      "I speak up when I see unsafe work practices.",
      "Following every safety rule is unrealistic in a fast-paced workplace.",
      "I wear all required safety equipment without being reminded.",
      "I would rather work quickly than worry about minor safety issues.",
      "I report near-miss incidents even if no one was hurt.",
      
      // Section E: Teamwork - Items 44-50
      "I work well with people from different backgrounds.",
      "I help coworkers when they are struggling with their tasks.",
      "I listen carefully to other people's ideas.",
      "I avoid conflicts with my coworkers.",
      "I share information that helps the team succeed.",
      "I am patient when training new employees.",
      "I support team decisions even when I initially disagreed."
    ];

    // Reverse scored items (marked with R in original)
    const REVERSE_SCORED = [16, 18, 20, 22, 24, 17, 19, 21, 23, 25, 27, 29, 31, 33, 35, 38, 40, 42];

    // Trait mappings
    const TRAIT_DIMENSIONS = {
      'Conscientiousness': { items: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], weight: 0.30 },
      'Emotional Stability': { items: [16,17,18,19,20,21,22,23,24,25], weight: 0.25 },
      'Integrity': { items: [26,27,28,29,30,31,32,33,34,35], weight: 0.20 },
      'Safety Orientation': { items: [36,37,38,39,40,41,42,43], weight: 0.15 },
      'Teamwork': { items: [44,45,46,47,48,49,50], weight: 0.10 }
    };

    // Interpretation texts
    const INTERPRETATIONS = {
      'Conscientiousness': {
        'High': 'Consistently meets deadlines and quality standards. Follows procedures without supervision. Takes initiative to solve problems. Maintains organized work environment. Shows up reliably and punctually.',
        'Medium': 'Generally organized and dependable but may have occasional lapses. Benefits from periodic check-ins and clear expectations.',
        'Low': 'Inconsistent work quality and missed deadlines. Requires frequent supervision. Disorganized work habits. Higher absenteeism risk.'
      },
      'Emotional Stability': {
        'High': 'Maintains composure during equipment breakdowns or rush orders. Handles criticism constructively. Adapts well to changes. Makes rational decisions under pressure.',
        'Medium': 'Typical stress reactions. May need support during peak pressure periods. Generally stable but occasional mood fluctuations.',
        'Low': 'Becomes anxious under pressure. May overreact to feedback. Struggles to adapt to changes. Takes longer to recover from setbacks.'
      },
      'Integrity': {
        'High': 'Reports safety violations honestly. Follows rules consistently. Handles company property responsibly. Admits mistakes. Can be trusted with confidential information.',
        'Medium': 'Generally honest but may see gray areas. Usually follows policies. Requires clear expectations about ethical standards.',
        'Low': 'May hide mistakes or problems. Risk of taking company property. Less reliable in unsupervised situations. Requires closer monitoring.'
      },
      'Safety Orientation': {
        'High': 'Consistently uses PPE. Identifies hazards proactively. Follows safety procedures precisely. Encourages safe practices. Views safety as integral to performance.',
        'Medium': 'Generally safety-conscious but may occasionally prioritize speed. Follows major safety rules. Benefits from safety reminders.',
        'Low': 'May skip safety equipment when rushed. Takes shortcuts. Rationalizes unsafe behaviors. Higher injury risk. Requires intensive safety training.'
      },
      'Teamwork': {
        'High': 'Shares knowledge willingly. Communicates clearly. Resolves conflicts constructively. Supports team goals. Shows patience with coworkers.',
        'Medium': 'Works adequately with others. May prefer independent work. Collaborates when required.',
        'Low': 'Prefers working alone. Limited communication. May create conflicts. Focuses on individual tasks over team success.'
      }
    };

    // Interview question bank used for follow-up questions by dimension and score band.
    // This global constant is reused both in the original generateInterviewQuestions
    // and in the deep-dive section of the report to suggest areas to explore.
    const QUESTION_BANK = {
      'Conscientiousness': {
        'Low': [
          'Tell me about a time when you had to manage multiple tasks with competing deadlines. How did you prioritize?',
          'Describe a situation where you made a mistake at work. How did you handle it?',
          'Give an example of when you had to work independently without supervision. How did you stay on track?',
          'How do you typically organize your workday and workspace?'
        ],
        'Medium': [
          'What systems or methods do you use to ensure quality in your work?',
          'Describe your approach to meeting deadlines when unexpected issues arise.',
          'How do you balance speed and accuracy in your work?'
        ],
        'High': [
          'What motivates you to maintain such high standards in your work?',
          'How do you help team members who struggle with organization or deadlines?'
        ]
      },
      'Emotional Stability': {
        'Low': [
          'Describe the most stressful situation you\'ve faced at work. How did you cope?',
          'Tell me about a time when plans changed suddenly. How did you adapt?',
          'How do you typically handle criticism or corrective feedback?',
          'What strategies do you use to manage stress during busy periods?'
        ],
        'Medium': [
          'Give an example of when you had to remain calm under pressure.',
          'How do you maintain focus when dealing with interruptions?'
        ],
        'High': [
          'How do you support colleagues who may be struggling with stress?',
          'What advice would you give someone starting in a high-pressure manufacturing role?'
        ]
      },
      'Integrity': {
        'Low': [
          'Describe a time when you witnessed someone breaking a rule. What did you do?',
          'Tell me about a situation where doing the right thing made your job harder.',
          'How would you handle finding expensive equipment left unsecured?',
          'What would you do if asked by a supervisor to do something against company policy?'
        ],
        'Medium': [
          'Give an example of an ethical dilemma you\'ve faced at work.',
          'How do you ensure compliance with policies when working alone?'
        ],
        'High': [
          'How do you encourage ethical behavior in your team?',
          'Describe a time when your integrity was tested.'
        ]
      },
      'Safety Orientation': {
        'Low': [
          'Tell me about a time when following safety procedures slowed down your work. What did you do?',
          'Describe a near-miss incident you\'ve witnessed or experienced. What did you learn?',
          'How would you respond if a coworker asked you to skip a safety step to meet a deadline?',
          'What\'s your view on the importance of reporting minor safety incidents?'
        ],
        'Medium': [
          'Give an example of when you identified a safety hazard others missed.',
          'How do you balance productivity demands with safety requirements?'
        ],
        'High': [
          'How do you promote safety awareness among your colleagues?',
          'Describe your most significant contribution to workplace safety.'
        ]
      },
      'Teamwork': {
        'Low': [
          'Tell me about a time you disagreed with a team decision. How did you handle it?',
          'Describe a situation where you had to work with someone you found difficult.',
          'How do you prefer to receive feedback from coworkers?',
          'Give an example of when you had to compromise for the team\'s benefit.'
        ],
        'Medium': [
          'How do you contribute to team morale during challenging projects?',
          'Describe your ideal working relationship with colleagues.'
        ],
        'High': [
          'How do you help integrate new team members?',
          'Give an example of when you went above and beyond to help a colleague.'
        ]
      }
    };

    // Global state

    // Capture campaign role from URL query parameter (e.g., ?campaign=production-operator). This
    // allows a job role or campaign identifier to be passed with the assessment link. The
    // captured value is stored globally and later added to candidateData so it can be
    // referenced in admin reporting. If the URL does not include a campaign parameter, this
    // remains null.
    const urlParams = new URLSearchParams(window.location.search);
    const campaignParam = urlParams.get('campaign');
    // Extract token from the URL or generate a new one. Each candidate has a unique
    // token used to identify their responses anonymously. If no token is provided
    // in the query string, generate a UUID and update the URL so the token persists
    // across page reloads or navigation.
    const tokenParam = urlParams.get('token');
    let candidateToken = tokenParam;
    if (!candidateToken) {
      candidateToken = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).substring(2) + Date.now().toString(36);
      const newParams = new URLSearchParams(window.location.search);
      newParams.set('token', candidateToken);
      history.replaceState(null, '', `${window.location.pathname}?${newParams.toString()}`);
    }

    // Initialize Supabase client. Insert your own Supabase project URL and anon key
    // here. These placeholders must be replaced with actual values from your
    // Supabase project settings (Settings → API → Project URL and Anon Key).
    const SUPABASE_URL = 'https://lduozjujlhoalahistnq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkdW96anVqbGhvYWxhaGlzdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1Nzk4MjYsImV4cCI6MjA3MjE1NTgyNn0.0xuC9nt8I7vlQaKc81hGZToshWvS35fumKvdFQgeh2I';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentPage = 0;
    let responses = {};
    let candidateData = {};
    let startTime = null;
    let pageStartTime = null;
    let itemLatencies = {};

    // Initialize
    function init() {
      document.getElementById('candidate-form').addEventListener('submit', handleCandidateInfo);
      loadStoredResults();

      // If a campaign parameter was provided, pre-select the corresponding option in
      // the position dropdown. This allows job-specific links to automatically set
      // the role in the candidate form. We wait until the DOM is loaded (init runs
      // after DOMContentLoaded) so the select element exists.
      if (campaignParam) {
        const positionSelect = document.getElementById('candidate-position');
        if (positionSelect) {
          // Only set the value if the option exists in the dropdown. If an invalid
          // campaign is passed it will not affect the dropdown.
          const optionExists = Array.from(positionSelect.options).some(opt => opt.value === campaignParam);
          if (optionExists) {
            positionSelect.value = campaignParam;
          }
        }
      }
    }

    // Screen navigation
    function hideAllScreens() {
      document.querySelectorAll('.card').forEach(card => {
        if (card.id !== 'header-card') {
          card.classList.add('hidden');
        }
      });
    }

    function showStart() {
      hideAllScreens();
      document.getElementById('screen-start').classList.remove('hidden');
    }

    function startAssessment() {
      hideAllScreens();
      document.getElementById('screen-info').classList.remove('hidden');
    }

    function showCandidateInfo() {
      hideAllScreens();
      document.getElementById('screen-info').classList.remove('hidden');
    }

    async function handleCandidateInfo(e) {
      e.preventDefault();
      // Build candidate data object. In addition to name, email, position and experience,
      // include the campaign parameter if provided in the link. This enables the admin
      // dashboard to associate a submission with a specific job role or hiring campaign
      // without requiring the candidate to re-enter this information. If no campaign was
      // specified, the field will be undefined.
      candidateData = {
        token: candidateToken,
        name: document.getElementById('candidate-name').value,
        email: document.getElementById('candidate-email').value,
        position: document.getElementById('candidate-position').value,
        experience: document.getElementById('candidate-experience').value,
        timestamp: new Date().toISOString(),
        campaign: campaignParam || undefined,
        progress: 0,
        completed: false,
        scores: null
      };
      // Persist candidate info to the Supabase back end. Ignore any errors so the
      // assessment continues even if the network call fails (e.g., offline use).
      try {
        await supabaseClient.from('candidates').insert([candidateData]);
      } catch (error) {
        console.error('Supabase candidate insert error:', error);
      }
      hideAllScreens();
      document.getElementById('screen-instructions').classList.remove('hidden');
    }

    function beginAssessment() {
      hideAllScreens();
      startTime = Date.now();
      pageStartTime = Date.now();
      currentPage = 0;
      responses = {};
      itemLatencies = {};
      renderQuestions();
      document.getElementById('screen-assessment').classList.remove('hidden');
    }

    function renderQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = '';
      
      const itemsPerPage = 5;
      const startIdx = currentPage * itemsPerPage;
      const endIdx = Math.min(startIdx + itemsPerPage, MPA50_QUESTIONS.length);
      
      for (let i = startIdx; i < endIdx; i++) {
        const questionNum = i + 1;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item';
        
        questionDiv.innerHTML = `
          <div class="question-text">
            <span class="question-number">${questionNum}</span>
            ${MPA50_QUESTIONS[i]}
          </div>
          <div class="likert-scale">
            <div class="likert-option">
              <input type="radio" id="q${questionNum}_1" name="q${questionNum}" value="1" ${responses[questionNum] == 1 ? 'checked' : ''}>
              <label for="q${questionNum}_1">1</label>
            </div>
            <div class="likert-option">
              <input type="radio" id="q${questionNum}_2" name="q${questionNum}" value="2" ${responses[questionNum] == 2 ? 'checked' : ''}>
              <label for="q${questionNum}_2">2</label>
            </div>
            <div class="likert-option">
              <input type="radio" id="q${questionNum}_3" name="q${questionNum}" value="3" ${responses[questionNum] == 3 ? 'checked' : ''}>
              <label for="q${questionNum}_3">3</label>
            </div>
            <div class="likert-option">
              <input type="radio" id="q${questionNum}_4" name="q${questionNum}" value="4" ${responses[questionNum] == 4 ? 'checked' : ''}>
              <label for="q${questionNum}_4">4</label>
            </div>
            <div class="likert-option">
              <input type="radio" id="q${questionNum}_5" name="q${questionNum}" value="5" ${responses[questionNum] == 5 ? 'checked' : ''}>
              <label for="q${questionNum}_5">5</label>
            </div>
          </div>
          <div class="likert-labels">
            <span>Strongly Disagree</span>
            <span>Strongly Agree</span>
          </div>
        `;
        
        container.appendChild(questionDiv);
        
        // Add event listeners
        for (let j = 1; j <= 5; j++) {
          document.getElementById(`q${questionNum}_${j}`).addEventListener('change', function() {
            responses[questionNum] = parseInt(this.value);
            if (!itemLatencies[questionNum]) {
              itemLatencies[questionNum] = Date.now() - pageStartTime;
            }
            // Persist individual responses to Supabase for progress tracking.
            try {
              supabaseClient.from('responses').insert([
                { token: candidateToken, question_index: questionNum, answer: parseInt(this.value) }
              ]);
            } catch (error) {
              console.error('Supabase response insert error:', error);
            }
          });
        }
      }
      
      // Update progress
      const progress = Math.round((startIdx / MPA50_QUESTIONS.length) * 100);
      document.getElementById('progress-bar').style.width = progress + '%';
      document.getElementById('progress-bar').textContent = progress + '%';
      document.getElementById('current-question').textContent = startIdx + 1;
      
      // Update navigation buttons
      document.getElementById('prev-btn').style.display = currentPage > 0 ? 'inline-block' : 'none';
      document.getElementById('next-btn').style.display = endIdx < MPA50_QUESTIONS.length ? 'inline-block' : 'none';
      document.getElementById('submit-btn').classList.toggle('hidden', endIdx < MPA50_QUESTIONS.length);
    }

    function previousPage() {
      if (currentPage > 0) {
        currentPage--;
        pageStartTime = Date.now();
        renderQuestions();
      }
    }

    async function nextPage() {
      // Validate current page responses
      const itemsPerPage = 5;
      const startIdx = currentPage * itemsPerPage;
      const endIdx = Math.min(startIdx + itemsPerPage, MPA50_QUESTIONS.length);
      
      for (let i = startIdx; i < endIdx; i++) {
        if (!responses[i + 1]) {
          alert('Please answer all questions on this page before continuing.');
          return;
        }
      }
      
      currentPage++;
      pageStartTime = Date.now();
      renderQuestions();

      // Update progress in back end (number of questions answered). Use a
      // try/catch to avoid interrupting user flow if the network is unavailable.
      try {
        const itemsPerPage = 5;
        const newProgress = Math.min(currentPage * itemsPerPage, MPA50_QUESTIONS.length);
        await supabaseClient.from('candidates')
          .update({ progress: newProgress })
          .eq('token', candidateToken);
      } catch (error) {
        console.error('Supabase progress update error:', error);
      }
    }

    async function submitAssessment() {
      // Validate all responses
      for (let i = 1; i <= MPA50_QUESTIONS.length; i++) {
        if (!responses[i]) {
          alert('Please answer all questions before submitting.');
          return;
        }
      }
      
      // Calculate scores
      const scores = calculateScores();
      
      // Save results
      const result = {
        ...candidateData,
        responses,
        scores,
        duration: Math.round((Date.now() - startTime) / 1000),
        completedAt: new Date().toISOString(),
        id: generateId()
      };

      // Update candidate row in Supabase with completion info and scores
      try {
        await supabaseClient.from('candidates')
          .update({
            completed: true,
            scores: scores,
            progress: MPA50_QUESTIONS.length,
            completedAt: result.completedAt
          })
          .eq('token', candidateToken);
      } catch (error) {
        console.error('Supabase final update error:', error);
      }

      saveResult(result);
      
      // Show thank you screen
      hideAllScreens();
      document.getElementById('screen-thankyou').classList.remove('hidden');
    }

    function calculateScores() {
      const scores = {};
      
      for (const [dimension, config] of Object.entries(TRAIT_DIMENSIONS)) {
        let sum = 0;
        let count = 0;
        
        config.items.forEach(itemNum => {
          let value = responses[itemNum];
          if (value) {
            // Apply reverse scoring
            if (REVERSE_SCORED.includes(itemNum)) {
              value = 6 - value;
            }
            sum += value;
            count++;
          }
        });
        
        const rawScore = count > 0 ? sum / count : 0;
        const percentile = getPercentile(rawScore);
        const band = getBand(rawScore);
        
        scores[dimension] = {
          raw: rawScore.toFixed(2),
          percentile,
          band,
          interpretation: INTERPRETATIONS[dimension][band]
        };
      }
      
      // Calculate Work Ethic Index (WEI)
      let weiSum = 0;
      let weiWeightSum = 0;
      
      for (const [dimension, config] of Object.entries(TRAIT_DIMENSIONS)) {
        if (scores[dimension].raw > 0) {
          weiSum += scores[dimension].raw * config.weight;
          weiWeightSum += config.weight;
        }
      }
      
      const weiRaw = weiWeightSum > 0 ? weiSum / weiWeightSum : 0;
      const wei = Math.round(((weiRaw - 1) / 4) * 100);
      
      scores.WEI = {
        value: wei,
        // Raise the bar for WEI banding: only scores of 85 or more are
        // considered Strong, 65-84 are Moderate, and anything below 65 is Low.
        band: wei >= 85 ? 'Strong' : wei >= 65 ? 'Moderate' : 'Low'
      };
      
      // Calculate risk assessment
      // Include the number of concerning responses across all items. This helps flag
      // candidates with many low-scoring responses as high risk even if their
      // dimension averages appear moderate. A "concerning" response is defined
      // as an adjusted score of 3 or less (after reverse scoring).
      let concerningCount = 0;
      for (let i = 1; i <= MPA50_QUESTIONS.length; i++) {
        const value = responses[i];
        if (value) {
          const isReversed = REVERSE_SCORED.includes(i);
          const adjusted = isReversed ? 6 - value : value;
          if (adjusted <= 3) {
            concerningCount++;
          }
        }
      }
      scores.concerningCount = concerningCount;

      scores.riskLevel = assessRisk(scores);
      
      return scores;
    }

    function getPercentile(rawScore) {
      // Simplified percentile calculation
      // Stricter percentile cutoffs reflecting a higher performance bar.
      // Scores near the maximum receive very high percentiles, while
      // moderate scores are penalised to highlight potential risk.
      if (rawScore >= 4.7) return 95;
      if (rawScore >= 4.4) return 90;
      if (rawScore >= 4.0) return 75;
      if (rawScore >= 3.6) return 60;
      if (rawScore >= 3.0) return 45;
      if (rawScore >= 2.5) return 30;
      if (rawScore >= 2.0) return 15;
      return 5;
    }

    function getBand(rawScore) {
      // Updated classification thresholds: candidates must score very high
      // to achieve the 'High' category; moderate performers are flagged as
      // needing further assessment.
      if (rawScore >= 4.4) return 'High';
      if (rawScore >= 3.6) return 'Medium';
      return 'Low';
    }

    function assessRisk(scores) {
      const critical = ['Conscientiousness', 'Safety Orientation', 'Integrity'];
      let riskPoints = 0;

      // If the candidate has many concerning responses across the entire
      // questionnaire, automatically classify them as high risk. A concerning
      // response is any adjusted score of 3 or less. We lowered the threshold
      // from 8 to 5 to raise the bar – if five or more items are concerning
      // (10% of the assessment), this indicates pervasive issues and the
      // overall risk should be high, not moderate.
      if (scores.concerningCount >= 5) {
        return 'High';
      }

      // Accumulate risk points from critical dimensions. Low scores add more
      // weight than medium scores. Any medium or low in these traits should
      // elevate the candidate into at least the Moderate risk category.
      critical.forEach(dimension => {
        const band = scores[dimension].band;
        if (band === 'Low') {
          riskPoints += 2;
        } else if (band === 'Medium') {
          riskPoints += 1;
        }
      });

      // Factor in overall work ethic index (WEI). Scores below 60 are
      // considered problematic and add two risk points. Scores between
      // 60 and 84 add one point. High WEI scores (85+) add no risk.
      if (scores.WEI.value < 60) {
        riskPoints += 2;
      } else if (scores.WEI.value < 85) {
        riskPoints += 1;
      }

      // Determine overall risk level. Any accumulated risk points
      // automatically elevate the result to at least Moderate risk.
      if (riskPoints >= 4) {
        return 'High';
      }
      if (riskPoints >= 1) {
        return 'Moderate';
      }
      return 'Low';
    }

    function generateId() {
      return 'MPA-' + Date.now().toString(36).toUpperCase();
    }

    function saveResult(result) {
      let results = JSON.parse(localStorage.getItem('mpa50_results') || '[]');
      results.push(result);
      localStorage.setItem('mpa50_results', JSON.stringify(results));
    }

    function loadStoredResults() {
      return JSON.parse(localStorage.getItem('mpa50_results') || '[]');
    }

    // Admin functions
    function showAdminLogin() {
      hideAllScreens();
      document.getElementById('screen-admin-login').classList.remove('hidden');
    }

    function adminLogin() {
      const password = document.getElementById('admin-password').value;
      if (password === 'mpa50admin') {  // Change this password
        showDashboard();
      } else {
        alert('Incorrect password');
      }
    }

    function showDashboard() {
      hideAllScreens();
      const results = loadStoredResults();
      const container = document.getElementById('dashboard-content');
      
      if (results.length === 0) {
        container.innerHTML = '<p>No assessment results available.</p>';
      } else {
        // Calculate summary statistics
        let totalCandidates = results.length;
        let recommendedCount = results.filter(r => r.scores.riskLevel === 'Low').length;
        let cautionCount = results.filter(r => r.scores.riskLevel === 'Moderate').length;
        let notRecommendedCount = results.filter(r => r.scores.riskLevel === 'High').length;
        let avgWEI = Math.round(results.reduce((sum, r) => sum + r.scores.WEI.value, 0) / totalCandidates);
        
        let html = `
          <div class="score-display" style="margin-bottom: 30px;">
            <div class="score-card">
              <div class="score-label">Total Candidates</div>
              <div class="score-value">${totalCandidates}</div>
            </div>
            <div class="score-card">
              <div class="score-label">Recommended</div>
              <div class="score-value" style="color: #48bb78;">${recommendedCount}</div>
              <span class="score-band band-high">${Math.round(recommendedCount/totalCandidates*100)}%</span>
            </div>
            <div class="score-card">
              <div class="score-label">Caution</div>
              <div class="score-value" style="color: #ecc94b;">${cautionCount}</div>
              <span class="score-band band-medium">${Math.round(cautionCount/totalCandidates*100)}%</span>
            </div>
            <div class="score-card">
              <div class="score-label">Not Recommended</div>
              <div class="score-value" style="color: #f56565;">${notRecommendedCount}</div>
              <span class="score-band band-low">${Math.round(notRecommendedCount/totalCandidates*100)}%</span>
            </div>
            <div class="score-card">
              <div class="score-label">Average WEI</div>
              <div class="score-value">${avgWEI}</div>
            </div>
          </div>
          
          <h3>Individual Results</h3>
          <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Position</th>
                <th>Campaign</th>
                <th>Date</th>
                <th>WEI</th>
                <th>Risk Level</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // Sort results by date (most recent first)
        const sortedResults = [...results].sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
        
        sortedResults.forEach((result, sortedIndex) => {
          // Find original index for viewReport
          const originalIndex = results.findIndex(r => r.id === result.id);
          const date = new Date(result.completedAt).toLocaleDateString();
          // Determine display label for risk level: rename 'Moderate' to 'Some Concerns'
          const riskDisplay = (result.scores.riskLevel === 'Moderate') ? 'Some Concerns' : result.scores.riskLevel;
          html += `
            <tr>
              <td>${result.id}</td>
              <td>${result.name}</td>
              <td>${result.position || 'N/A'}</td>
              <td>${result.campaign || 'N/A'}</td>
              <td>${date}</td>
              <td>${result.scores.WEI.value}</td>
              <td><span class="risk-indicator risk-${result.scores.riskLevel.toLowerCase()}">${riskDisplay}</span></td>
              <td><button class="btn btn-primary" onclick="viewReport(${originalIndex})">View Report</button></td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }
      
      document.getElementById('screen-dashboard').classList.remove('hidden');
    }

    function viewReport(index) {
      const results = loadStoredResults();
      const result = results[index];

      hideAllScreens();
      const container = document.getElementById('report-content');

      // Compute overall average of raw trait scores
      let rawSum = 0;
      let dimCount = 0;
      for (const dimension of Object.keys(TRAIT_DIMENSIONS)) {
        rawSum += parseFloat(result.scores[dimension].raw);
        dimCount++;
      }
      const overallAvg = (rawSum / dimCount).toFixed(2);

      const riskLevel = result.scores.riskLevel;
      // Display label: rename 'Moderate' to 'Some Concerns' for better clarity
      const displayRiskLevel = (riskLevel === 'Moderate') ? 'Some Concerns' : riskLevel;
      let overviewText;
      if (riskLevel === 'Low') {
        overviewText = 'Overall, the candidate displays strong personality traits associated with success in manufacturing roles.';
      } else if (riskLevel === 'Moderate') {
        overviewText = 'Overall, the candidate presents some concerns and a mixture of strengths and potential risks. Proceed with caution and probe flagged areas further during interviews.';
      } else {
        overviewText = 'Overall, the candidate has significant risk factors based on the personality profile. Consider alternative roles or intensive training.';
      }

      // Build an aggregated list of follow‑up interview questions for all
      // dimensions where the candidate scored Medium or Low. This will be
      // displayed at the end of the report to help recruiters prepare.
      const aggregatedQuestionsSet = new Set();
      for (const dimension of Object.keys(TRAIT_DIMENSIONS)) {
        const dimScore = result.scores[dimension];
        if (dimScore.band === 'Low' || dimScore.band === 'Medium') {
          const bandKey = dimScore.band;
          if (QUESTION_BANK[dimension] && QUESTION_BANK[dimension][bandKey]) {
            QUESTION_BANK[dimension][bandKey].forEach(q => aggregatedQuestionsSet.add(q));
          }
        }
      }
      const aggregatedQuestions = Array.from(aggregatedQuestionsSet);
      // Limit the list of follow‑up questions to the five most relevant items. By slicing
      // the aggregated array to the first five entries, we provide hiring managers with
      // a concise set of interview prompts focused on the candidate's most critical
      // strengths or weaknesses.
      const topQuestions = aggregatedQuestions.slice(0, 5);
      // Capture additional interview questions beyond the top five.
      const extraQuestions = aggregatedQuestions.slice(5, 10);

      let html = '';
      html += `<h2>Candidate Report</h2>`;

      // Overview Summary section
      html += `<div class="report-section"><h3>Overview Summary</h3>
        <p>${overviewText}</p>
        <p><strong>Overall Average Score:</strong> ${overallAvg} / 5</p>
        <div class="score-display">
          <div class="score-card">
            <div class="score-label">Work Ethic Index</div>
            <div class="score-value">${result.scores.WEI.value}</div>
            <span class="score-band band-${result.scores.WEI.band.toLowerCase()}">${result.scores.WEI.band}</span>
          </div>
          <div class="score-card">
            <div class="score-label">Risk Assessment</div>
            <!-- Use displayRiskLevel for user-facing text while retaining original risk classes -->
            <div class="score-value">${displayRiskLevel}</div>
            <span class="risk-indicator risk-${riskLevel.toLowerCase()}">${displayRiskLevel} Risk</span>
          </div>
        </div>
      </div>`;

      // Candidate Information section
      html += `<div class="report-section"><h3>Candidate Information</h3><table>
        <tr><td><strong>ID:</strong></td><td>${result.id}</td></tr>
        <tr><td><strong>Name:</strong></td><td>${result.name}</td></tr>
        <tr><td><strong>Email:</strong></td><td>${result.email || 'N/A'}</td></tr>
        <tr><td><strong>Position:</strong></td><td>${result.position || 'N/A'}</td></tr>
        <tr><td><strong>Campaign:</strong></td><td>${result.campaign || 'N/A'}</td></tr>
        <tr><td><strong>Experience:</strong></td><td>${result.experience || 'N/A'}</td></tr>
        <tr><td><strong>Assessment Date:</strong></td><td>${new Date(result.completedAt).toLocaleString()}</td></tr>
        <tr><td><strong>Duration:</strong></td><td>${result.duration} seconds</td></tr>
        </table></div>`;

      // Next step recommendation section
      const nextRec = getNextStepRecommendation(riskLevel);
      html += `<div class="report-section"><h3>Next Step Recommendation</h3><p><strong>Recommendation:</strong> ${nextRec}</p></div>`;

      // Summary by trait
      html += `<div class="report-section"><h3>Summary by Trait</h3>
        <p style="margin-bottom:10px;">For each trait, we display the number of responses in each category: <em>Good</em> (green), <em>Some Concerns</em> (yellow) and <em>Concerning</em> (red). A band indicating some concerns or low performance triggers a risk flag to prompt further assessment.</p>`;

      for (const dimension of Object.keys(TRAIT_DIMENSIONS)) {
        const score = result.scores[dimension];
        const band = score.band;
        // Derive a user‑friendly label: rename 'Medium' to 'Some Concerns'
        const displayBand = (band === 'Medium') ? 'Some Concerns' : band;
        const flag = (band === 'Medium' || band === 'Low') ? ' <span class="risk-flag">⚠ Assess concerns</span>' : '';
        // Count the status breakdown for this dimension
        const counts = countStatus(result.responses, dimension);
        // Build summary card with renamed labels
        html += `<div class="trait-summary">
          <h4>${dimension}: ${score.raw} (${displayBand})${flag}</h4>
          <p><strong>Response Breakdown:</strong> Good: ${counts.good}, Some Concerns: ${counts.moderate}, Concerning: ${counts.concerning}</p>
          <p><strong>Observation:</strong> ${score.interpretation}</p>
          <p><strong>Recommendation:</strong> ${getRecommendation(dimension, band)}</p>
        </div>`;
      }
      html += `</div>`;

      // Aggregated interview questions section
      if (topQuestions.length > 0) {
        html += `<div class="report-section"><h3>Top Interview Questions</h3>`;
        html += `<p>Use the following tailored questions to explore the candidate's most noteworthy areas based on their assessment responses:</p>`;
        html += `<ul>`;
        topQuestions.forEach(q => {
          html += `<li>${q}</li>`;
        });
        html += `</ul></div>`;
      }
      // If there are more interview questions available beyond the top five,
      // provide an additional section to explore them.
      if (extraQuestions.length > 0) {
        html += `<div class="report-section"><h3>Additional Interview Questions</h3>`;
        html += `<p>If time permits, explore these additional topics for deeper insights:</p>`;
        html += `<ul>`;
        extraQuestions.forEach(q => {
          html += `<li>${q}</li>`;
        });
        html += `</ul></div>`;
      }

      // Deep dive by dimension
      html += `<div class="report-section"><h3>Deep Dive by Dimension</h3>`;
      // Add a legend for mini heat map colors to improve clarity
      html += `<p style="margin-bottom:10px;font-size:0.9rem;">
        <span class="mini-cell good"></span> Good
        <span class="mini-cell moderate"></span> Some Concerns
        <span class="mini-cell concerning"></span> Concerning
        <span class="mini-cell empty reverse" style="border:2px solid #805ad5; background:transparent;"></span> Reverse Scored Item
      </p>`;
      for (const dimension of Object.keys(TRAIT_DIMENSIONS)) {
        const score = result.scores[dimension];
        html += `<div class="deep-dive">
          <h4>${dimension} (Score ${score.raw} – ${score.band})</h4>
          ${generateMiniHeat(result.responses, dimension)}
          <table>
            <thead><tr><th>#</th><th>Question</th><th>Response</th><th>Status</th></tr></thead><tbody>`;
        const items = TRAIT_DIMENSIONS[dimension].items;
        items.forEach(itemNum => {
          const value = result.responses[itemNum];
          const isReverse = REVERSE_SCORED.includes(itemNum);
          const adjusted = isReverse ? 6 - value : value;
          let status;
          let statusClass;
          if (adjusted >= 5) {
            status = 'Good';
            statusClass = 'good';
          } else if (adjusted === 4) {
            // Rename "Moderate" status for clarity
            status = 'Some Concerns';
            statusClass = 'moderate';
          } else {
            status = 'Concerning';
            statusClass = 'concerning';
          }
          const responseLabel = getLikertLabel(value);
          html += `<tr class="${statusClass}${isReverse ? ' reverse' : ''}">
            <td>${itemNum}</td>
            <td>${MPA50_QUESTIONS[itemNum - 1]}</td>
            <td>${value} (${responseLabel})${isReverse ? ' (R)' : ''}</td>
            <td>${status}${status !== 'Good' ? ' ⚠' : ''}</td>
          </tr>`;
        });
        html += `</tbody></table>
          <p><strong>Interpretation:</strong> ${score.interpretation}</p>`;
        if (score.band === 'Medium' || score.band === 'Low') {
          html += `<p><strong>Risks:</strong> `;
          if (score.band === 'Low') {
            html += `This low score suggests significant challenges related to ${dimension.toLowerCase()}.`;
          } else {
            // When the band is Medium (displayed as Some Concerns), explain the concern
            html += `This score indicates some concerns that warrant further exploration.`;
          }
          html += `</p>`;
        }
        let followUps = [];
        if (score.band === 'Low' && QUESTION_BANK[dimension] && QUESTION_BANK[dimension]['Low']) {
          followUps = QUESTION_BANK[dimension]['Low'];
        } else if (score.band === 'Medium' && QUESTION_BANK[dimension] && QUESTION_BANK[dimension]['Medium']) {
          followUps = QUESTION_BANK[dimension]['Medium'];
        }
        if (followUps.length > 0) {
          html += `<p><strong>Areas to Explore in Interview:</strong></p><ul>`;
          followUps.forEach(q => {
            html += `<li>${q}</li>`;
          });
          html += `</ul>`;
        }
        html += `</div>`;
      }
      html += `</div>`;

      // Important note at bottom
      html += `<div class="report-section" style="background:#fff5f5;border-left-color:#f56565;">
        <p><strong>Important Note:</strong> This assessment should be used as one component of a comprehensive hiring process. Always combine with interviews, reference checks, skills assessments, and other job-relevant evaluations. Ensure compliance with all applicable employment laws and regulations.</p>
      </div>`;

      container.innerHTML = html;
      document.getElementById('screen-report').classList.remove('hidden');
    }
    
    function generateHeatMap(responses) {
      let html = '<div class="heatmap-container"><div class="heatmap-grid">';
      
      // Header row
      html += '<div class="heatmap-row-label">Dimension</div>';
      for (let i = 1; i <= 50; i++) {
        html += `<div style="background: #4a5568; color: white; padding: 8px 4px; text-align: center; border-radius: 4px; font-weight: 600;">${i}</div>`;
      }
      
      // Data rows for each dimension
      for (const [dimension, config] of Object.entries(TRAIT_DIMENSIONS)) {
        html += `<div class="heatmap-row-label">${dimension.substring(0, 10)}</div>`;
        
        for (let i = 1; i <= 50; i++) {
          if (config.items.includes(i)) {
            let value = responses[i] || 0;
            let displayValue = value;
            let isReversed = REVERSE_SCORED.includes(i);
            
            if (isReversed) {
              displayValue = 6 - value;
            }
            
            const tooltip = `Q${i}: ${MPA50_QUESTIONS[i-1].substring(0, 50)}... (${isReversed ? 'Reversed' : 'Normal'})`;
            html += `<div class="heatmap-cell heat-${displayValue} ${isReversed ? 'heat-rev' : ''}" 
                     data-tooltip="${tooltip}">${value}</div>`;
          } else {
            html += '<div style="background: #e2e8f0;"></div>';
          }
        }
      }
      
      html += '</div></div>';
      
      // Legend
      html += `
        <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
          <span style="font-weight: 600;">Legend:</span>
          <span><span class="heat-1" style="padding: 4px 8px; border-radius: 4px; color: white;">1</span> Strongly Disagree</span>
          <span><span class="heat-2" style="padding: 4px 8px; border-radius: 4px; color: white;">2</span> Disagree</span>
          <span><span class="heat-3" style="padding: 4px 8px; border-radius: 4px; color: white;">3</span> Neutral</span>
          <span><span class="heat-4" style="padding: 4px 8px; border-radius: 4px; color: white;">4</span> Agree</span>
          <span><span class="heat-5" style="padding: 4px 8px; border-radius: 4px; color: white;">5</span> Strongly Agree</span>
          <span><span style="border: 3px solid #805ad5; padding: 2px 6px; border-radius: 4px;">R</span> Reverse Scored</span>
        </div>
      `;
      
      return html;
    }
    
    function generateResponseBreakdown(responses) {
      let html = '<table class="response-table"><thead><tr><th>#</th><th>Question</th><th>Response</th><th>Score</th><th>Dimension</th></tr></thead><tbody>';
      
      for (let i = 1; i <= 50; i++) {
        const value = responses[i] || 0;
        const isReversed = REVERSE_SCORED.includes(i);
        const adjustedScore = isReversed ? 6 - value : value;
        
        // Find which dimension this belongs to
        let dimension = '';
        for (const [dim, config] of Object.entries(TRAIT_DIMENSIONS)) {
          if (config.items.includes(i)) {
            dimension = dim;
            break;
          }
        }
        
        const responseClass = adjustedScore >= 4 ? 'band-high' : adjustedScore <= 2 ? 'band-low' : 'band-medium';
        
        html += `
          <tr>
            <td>${i}</td>
            <td>${MPA50_QUESTIONS[i-1]}</td>
            <td><span class="response-value heat-${value}">${value}</span></td>
            <td><span class="response-value ${responseClass}">${adjustedScore}</span> ${isReversed ? '(R)' : ''}</td>
            <td>${dimension}</td>
          </tr>
        `;
      }
      
      html += '</tbody></table>';
      return html;
    }

    /**
     * Convert a Likert numeric response into a human-readable label.
     * This helper returns the full textual description used in the report
     * tables (e.g., 1 → "Strongly Disagree", 5 → "Strongly Agree").
     * If an unknown value is supplied, it gracefully returns the value as-is.
     */
    function getLikertLabel(value) {
      switch (parseInt(value, 10)) {
        case 1: return 'Strongly Disagree';
        case 2: return 'Disagree';
        case 3: return 'Neutral';
        case 4: return 'Agree';
        case 5: return 'Strongly Agree';
        default: return value;
      }
    }

    /**
     * Generate a miniature heat strip for a single trait, showing all item responses
     * belonging to that trait in a condensed row. Each cell displays the raw response,
     * and reverse-scored items are flagged with an "R" tooltip. Colors correspond
     * to adjusted scores (green for high, yellow for medium, red for low).
     *
     * @param {Object} responses - keyed by item number (1–50) to raw values.
     * @param {String} dimension - the trait key from TRAIT_DIMENSIONS.
     * @returns {String} - HTML string for the mini heat strip.
     */
    function generateMiniHeat(responses, dimension) {
      const items = TRAIT_DIMENSIONS[dimension].items;
      let html = '<div class="mini-heat">';
      items.forEach(itemNum => {
        const raw = responses[itemNum];
        if (!raw) {
          html += '<span class="mini-cell empty"></span>';
          return;
        }
        const isReverse = REVERSE_SCORED.includes(itemNum);
        const adjusted = isReverse ? 6 - raw : raw;
        let cls = '';
        if (adjusted >= 5) cls = 'good';
        else if (adjusted === 4) cls = 'moderate';
        else cls = 'concerning';
        const tooltip = `Q${itemNum}: ${MPA50_QUESTIONS[itemNum - 1].substring(0, 50)}...`;
        // Display only a colored cell without the numeric value to simplify the visual.
        html += `<span class="mini-cell ${cls}${isReverse ? ' reverse' : ''}" title="${tooltip}"></span>`;
      });
      html += '</div>';
      return html;
    }

  /**
   * Count the number of good, moderate and concerning responses for a given
   * dimension. This helper produces a simple breakdown that can be used
   * instead of a mini heat map in summary tables. A response is considered
   * good if the adjusted score is 5 or higher, moderate if it equals 4,
   * and concerning if 3 or less.
   *
   * @param {Object} responses - map of question number to raw response (1–5).
   * @param {String} dimension - trait name.
   * @returns {Object} - {good: Number, moderate: Number, concerning: Number}
   */
  function countStatus(responses, dimension) {
    const items = TRAIT_DIMENSIONS[dimension].items;
    const counts = { good: 0, moderate: 0, concerning: 0 };
    items.forEach(itemNum => {
      const raw = responses[itemNum];
      if (!raw) return;
      const isReverse = REVERSE_SCORED.includes(itemNum);
      const adjusted = isReverse ? 6 - raw : raw;
      if (adjusted >= 5) counts.good++;
      else if (adjusted === 4) counts.moderate++;
      else counts.concerning++;
    });
    return counts;
  }

    /**
     * Provide a concise recommendation based on the trait and the band.
     * For strong traits we suggest leveraging the strength; for medium
     * we suggest probing further; for low we advise serious caution or
     * additional support. These statements appear in the summary table.
     *
     * @param {String} dimension - the trait name.
     * @param {String} band - "High", "Medium", or "Low".
     * @returns {String} - recommendation sentence.
     */
    function getRecommendation(dimension, band) {
      if (band === 'High') {
        return `Leverage the candidate's strong ${dimension.toLowerCase()} in this role.`;
      } else if (band === 'Medium') {
        return `Probe ${dimension.toLowerCase()} further during interviews; there may be underlying risks.`;
      } else {
        return `This candidate shows low ${dimension.toLowerCase()}; consider role suitability and training needs.`;
      }
    }

    /**
     * Determine whether the candidate should move forward in the selection process
     * based on the overall risk level. This function returns a clear statement
     * outlining whether to proceed, proceed with caution, or stop.
     *
     * @param {String} riskLevel - 'Low', 'Moderate' or 'High'
     * @returns {String} - recommendation for next step.
     */
    function getNextStepRecommendation(riskLevel) {
      if (riskLevel === 'Low') {
        return 'Proceed to the next stage of the selection process.';
      } else if (riskLevel === 'Moderate') {
        return 'Proceed with caution: conduct additional interviews and evaluations.';
      } else if (riskLevel === 'High') {
        return 'Do not advance the candidate at this time.';
      }
      return '';
    }
    
    function generateInterviewQuestions(scores) {
      let html = '';
      
      // Specific questions for each dimension based on score
      const questionBank = {
        'Conscientiousness': {
          'Low': [
            'Tell me about a time when you had to manage multiple tasks with competing deadlines. How did you prioritize?',
            'Describe a situation where you made a mistake at work. How did you handle it?',
            'Give an example of when you had to work independently without supervision. How did you stay on track?',
            'How do you typically organize your workday and workspace?'
          ],
          'Medium': [
            'What systems or methods do you use to ensure quality in your work?',
            'Describe your approach to meeting deadlines when unexpected issues arise.',
            'How do you balance speed and accuracy in your work?'
          ],
          'High': [
            'What motivates you to maintain such high standards in your work?',
            'How do you help team members who struggle with organization or deadlines?'
          ]
        },
        'Emotional Stability': {
          'Low': [
            'Describe the most stressful situation you\'ve faced at work. How did you cope?',
            'Tell me about a time when plans changed suddenly. How did you adapt?',
            'How do you typically handle criticism or corrective feedback?',
            'What strategies do you use to manage stress during busy periods?'
          ],
          'Medium': [
            'Give an example of when you had to remain calm under pressure.',
            'How do you maintain focus when dealing with interruptions?'
          ],
          'High': [
            'How do you support colleagues who may be struggling with stress?',
            'What advice would you give someone starting in a high-pressure manufacturing role?'
          ]
        },
        'Integrity': {
          'Low': [
            'Describe a time when you witnessed someone breaking a rule. What did you do?',
            'Tell me about a situation where doing the right thing made your job harder.',
            'How would you handle finding expensive equipment left unsecured?',
            'What would you do if asked by a supervisor to do something against company policy?'
          ],
          'Medium': [
            'Give an example of an ethical dilemma you\'ve faced at work.',
            'How do you ensure compliance with policies when working alone?'
          ],
          'High': [
            'How do you encourage ethical behavior in your team?',
            'Describe a time when your integrity was tested.'
          ]
        },
        'Safety Orientation': {
          'Low': [
            'Tell me about a time when following safety procedures slowed down your work. What did you do?',
            'Describe a near-miss incident you\'ve witnessed or experienced. What did you learn?',
            'How would you respond if a coworker asked you to skip a safety step to meet a deadline?',
            'What\'s your view on the importance of reporting minor safety incidents?'
          ],
          'Medium': [
            'Give an example of when you identified a safety hazard others missed.',
            'How do you balance productivity demands with safety requirements?'
          ],
          'High': [
            'How do you promote safety awareness among your colleagues?',
            'Describe your most significant contribution to workplace safety.'
          ]
        },
        'Teamwork': {
          'Low': [
            'Tell me about a time you disagreed with a team decision. How did you handle it?',
            'Describe a situation where you had to work with someone you found difficult.',
            'How do you prefer to receive feedback from coworkers?',
            'Give an example of when you had to compromise for the team\'s benefit.'
          ],
          'Medium': [
            'How do you contribute to team morale during challenging projects?',
            'Describe your ideal working relationship with colleagues.'
          ],
          'High': [
            'How do you help integrate new team members?',
            'Give an example of when you went above and beyond to help a colleague.'
          ]
        }
      };
      
      // Critical areas to explore (Low scores)
      const criticalAreas = [];
      const cautionAreas = [];
      
      for (const [dimension, score] of Object.entries(scores)) {
        if (dimension !== 'WEI' && dimension !== 'riskLevel') {
          if (score.band === 'Low') {
            criticalAreas.push({ dimension, questions: questionBank[dimension]['Low'] });
          } else if (score.band === 'Medium') {
            cautionAreas.push({ dimension, questions: questionBank[dimension]['Medium'] });
          }
        }
      }
      
      if (criticalAreas.length > 0) {
        html += '<div class="interview-section"><h4 style="color: #f56565;">🔴 Critical Areas to Explore (Low Scores)</h4>';
        criticalAreas.forEach(area => {
          html += `<div class="interview-category">
            <h4>${area.dimension}</h4>`;
          area.questions.forEach(q => {
            html += `<div class="interview-question critical">${q}</div>`;
          });
          html += '</div>';
        });
        html += '</div>';
      }
      
      if (cautionAreas.length > 0) {
        html += '<div class="interview-section"><h4 style="color: #ecc94b;">⚠️ Areas for Further Discussion (Medium Scores)</h4>';
        cautionAreas.forEach(area => {
          html += `<div class="interview-category">
            <h4>${area.dimension}</h4>`;
          area.questions.forEach(q => {
            html += `<div class="interview-question">${q}</div>`;
          });
          html += '</div>';
        });
        html += '</div>';
      }
      
      // Add situational questions based on position
      html += `<div class="interview-section">
        <h4>📋 Additional Behavioral Questions</h4>
        <div class="interview-category">
          <div class="interview-question">Describe your experience with manufacturing equipment and machinery.</div>
          <div class="interview-question">How do you ensure consistent quality in repetitive tasks?</div>
          <div class="interview-question">Tell me about a time you identified a process improvement opportunity.</div>
          <div class="interview-question">How do you stay alert and engaged during long shifts?</div>
          <div class="interview-question">What does "taking pride in your work" mean to you?</div>
        </div>
      </div>`;
      
      return html;
    }
    
    function toggleCollapsible(element) {
      element.classList.toggle('active');
      const content = element.nextElementSibling;
      content.classList.toggle('active');
    }

    function exportResults() {
      const results = loadStoredResults();
      if (results.length === 0) {
        alert('No results to export');
        return;
      }
      
      // Create comprehensive CSV with all responses and scores
      let csv = 'ID,Name,Email,Position,Experience,Date,Duration(sec),WEI,WEI_Band,Risk_Level,';
      csv += 'Conscientiousness,Conscientiousness_Band,Conscientiousness_Percentile,';
      csv += 'Emotional_Stability,Emotional_Stability_Band,Emotional_Stability_Percentile,';
      csv += 'Integrity,Integrity_Band,Integrity_Percentile,';
      csv += 'Safety_Orientation,Safety_Orientation_Band,Safety_Orientation_Percentile,';
      csv += 'Teamwork,Teamwork_Band,Teamwork_Percentile,';
      
      // Add headers for all 50 questions
      for (let i = 1; i <= 50; i++) {
        csv += `Q${i}_Response,Q${i}_Adjusted,`;
      }
      csv = csv.slice(0, -1) + '\n';
      
      results.forEach(result => {
        const row = [
          result.id,
          result.name,
          result.email || '',
          result.position || '',
          result.experience || '',
          new Date(result.completedAt).toLocaleDateString(),
          result.duration,
          result.scores.WEI.value,
          result.scores.WEI.band,
          result.scores.riskLevel
        ];
        
        // Add dimension scores
        for (const dimension of Object.keys(TRAIT_DIMENSIONS)) {
          row.push(
            result.scores[dimension].raw,
            result.scores[dimension].band,
            result.scores[dimension].percentile
          );
        }
        
        // Add all individual responses
        for (let i = 1; i <= 50; i++) {
          const response = result.responses[i] || '';
          const adjusted = response ? (REVERSE_SCORED.includes(i) ? 6 - response : response) : '';
          row.push(response, adjusted);
        }
        
        csv += row.map(val => `"${val}"`).join(',') + '\n';
      });
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mpa50_detailed_results_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function clearAllData() {
      if (confirm('Are you sure you want to delete all assessment data? This action cannot be undone.')) {
        localStorage.removeItem('mpa50_results');
        alert('All data has been cleared.');
        showDashboard();
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // Expose key functions globally so inline onclick handlers work correctly.
    // Without this assignment, some browsers may not find the functions in
    // the global scope when called via inline attributes on buttons.
    Object.assign(window, {
      startAssessment,
      showCandidateInfo,
      showStart,
      beginAssessment,
      previousPage,
      nextPage,
      submitAssessment,
      showAdminLogin,
      adminLogin,
      showDashboard,
      viewReport,
      exportResults,
      clearAllData
    });

    // Ensure the start screen is visible on initial load. In some cases the
    // start card could remain hidden when reloading after completing an
    // assessment. Calling showStart() here will reset the UI.
    document.addEventListener('DOMContentLoaded', () => {
      showStart();
    });
  </script>
</body>
</html>
